<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Estimateur FDV Crypto</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <style>
    .bar {
      transition: width 0.5s ease;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div class="max-w-6xl mx-auto p-8">
    <div class="bg-white rounded-lg shadow-xl p-8">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">üöÄ Estimateur FDV de Token Crypto</h1>
      <p class="text-gray-600 mb-6">Estimation automatique via Vercel Edge Functions</p>
      
      <p id="lastUpdate" class="text-sm text-gray-500 mb-4"></p>
      
      <button 
        id="refreshBtn" 
        class="mb-6 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition"
      >
        üîÑ Actualiser les donn√©es
      </button>
      
      <div id="error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6"></div>
      
      <div id="loading" class="hidden text-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
        <p class="mt-4 text-gray-600">R√©cup√©ration des donn√©es...</p>
      </div>
      
      <div id="content" class="hidden">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Graphique FDV vs Revenu (√âchelle Log)</h2>
        <div class="mb-8 bg-gray-50 p-4 rounded-lg">
          <canvas id="scatterChart" style="max-height: 500px;"></canvas>
          <p class="text-xs text-gray-600 mt-2 text-center">
            üí° Survolez les points pour voir les d√©tails
          </p>
        </div>
        
        <h2 class="text-xl font-bold text-gray-800 mb-4">Donn√©es d√©taill√©es</h2>
        <div class="overflow-x-auto mb-8">
          <table class="w-full border-collapse text-sm">
            <thead>
              <tr class="bg-indigo-600 text-white">
                <th class="px-3 py-2 text-left cursor-pointer hover:bg-indigo-700" onclick="sortTable('name')">
                  Projet <span id="sort-name" class="text-xs">‚ÜïÔ∏è</span>
                </th>
                <th class="px-3 py-2 text-right cursor-pointer hover:bg-indigo-700" onclick="sortTable('avgDailyFees')">
                  Moy. 7j <span id="sort-avgDailyFees" class="text-xs">‚ÜïÔ∏è</span>
                </th>
                <th class="px-3 py-2 text-right cursor-pointer hover:bg-indigo-700" onclick="sortTable('revenue')">
                  Revenu Annuel <span id="sort-revenue" class="text-xs">‚ÜïÔ∏è</span>
                </th>
                <th class="px-3 py-2 text-right cursor-pointer hover:bg-indigo-700" onclick="sortTable('fdv')">
                  FDV <span id="sort-fdv" class="text-xs">‚ÜïÔ∏è</span>
                </th>
                <th class="px-3 py-2 text-right cursor-pointer hover:bg-indigo-700" onclick="sortTable('ratio')">
                  Ratio <span id="sort-ratio" class="text-xs">‚ÜïÔ∏è</span>
                </th>
                <th class="px-3 py-2 text-center cursor-pointer hover:bg-indigo-700" onclick="sortTable('hasToken')">
                  Statut <span id="sort-hasToken" class="text-xs">‚Üì</span>
                </th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
        
        <div class="p-4 bg-blue-50 rounded-lg">
          <h3 class="font-semibold text-gray-800 mb-2">üí° Comment √ßa marche ?</h3>
          <ul class="text-sm text-gray-700 space-y-1">
            <li>‚Ä¢ Vercel Edge Functions : API backend qui contourne CORS</li>
            <li>‚Ä¢ DeFiLlama : Donn√©es de revenus en temps r√©el (moyenne 7 jours)</li>
            <li>‚Ä¢ CoinGecko : FDV des tokens live</li>
            <li>‚Ä¢ R√©gression lin√©aire pond√©r√©e : Estimation bas√©e sur les gros projets</li>
            <li>‚Ä¢ √âchelle logarithmique : Meilleure visualisation des diff√©rents ordres de grandeur</li>
          </ul>
        </div>
      </div>
      
      <details class="mt-6">
        <summary class="cursor-pointer text-sm font-semibold text-gray-700 hover:text-gray-900">
          üîç Logs de debug
        </summary>
        <div id="debugLogs" class="mt-2 p-4 bg-gray-100 rounded text-xs font-mono overflow-x-auto max-h-96 overflow-y-auto"></div>
      </details>
    </div>
  </div>

  <script>
    let allProjects = [];
    let currentSort = { column: 'hasToken', direction: 'desc' };
    let scatterChartInstance = null;
    
    const projectsConfig = [
      { 
        name: 'Hyperliquid', 
        hasToken: true, 
        defillamaSlug: 'hyperliquid',
        coingeckoId: 'hyperliquid'
      },
      { 
        name: 'Lighter', 
        hasToken: true, 
        defillamaSlug: 'lighter',
        coingeckoId: 'lighter'
      },
      { 
        name: 'Aster', 
        hasToken: true, 
        defillamaSlug: 'aster',
        coingeckoId: 'aster-2'
      },
      { 
        name: 'dYdX', 
        hasToken: true, 
        defillamaSlug: 'dydx',
        coingeckoId: 'dydx-chain'
      },
      { 
        name: 'Avantis', 
        hasToken: true, 
        defillamaSlug: 'avantis',
        coingeckoId: 'avantis'
      },
      { 
        name: 'Extended', 
        hasToken: false, 
        defillamaSlug: 'extended',
        coingeckoId: null
      },
      { 
        name: 'Paradex', 
        hasToken: false, 
        defillamaSlug: 'paradex',
        coingeckoId: null
      },
      { 
        name: 'EdgeX', 
        hasToken: false, 
        defillamaSlug: 'edgex',
        coingeckoId: null
      },
      { 
        name: 'Reya', 
        hasToken: false, 
        defillamaSlug: 'reya-network',
        coingeckoId: null
      },
      { 
        name: 'Ethereal', 
        hasToken: false, 
        defillamaSlug: 'ethereal',
        coingeckoId: null
      },
      { 
        name: 'Ostium', 
        hasToken: false, 
        defillamaSlug: 'ostium',
        coingeckoId: null
      },
      { 
        name: 'Unit', 
        hasToken: false, 
        defillamaSlug: 'unit',
        coingeckoId: null
      }
    ];

    let debugLogs = [];

    function addLog(message) {
      debugLogs.push(message);
      const logsDiv = document.getElementById('debugLogs');
      logsDiv.innerHTML = debugLogs.join('<br>');
    }

    function formatCurrency(value) {
      if (!value && value !== 0) return 'N/A';
      
      const absValue = Math.abs(value);
      const sign = value < 0 ? '-' : '';
      
      if (absValue >= 1e9) {
        return `${sign}$${(absValue / 1e9).toFixed(2)}B`;
      } else if (absValue >= 1e6) {
        return `${sign}$${(absValue / 1e6).toFixed(2)}M`;
      } else if (absValue >= 1e3) {
        return `${sign}$${(absValue / 1e3).toFixed(2)}K`;
      }
      return `${sign}$${absValue.toFixed(2)}`;
    }

    async function fetchData() {
      const loadingDiv = document.getElementById('loading');
      const contentDiv = document.getElementById('content');
      const errorDiv = document.getElementById('error');
      const refreshBtn = document.getElementById('refreshBtn');
      
      loadingDiv.classList.remove('hidden');
      contentDiv.classList.add('hidden');
      errorDiv.classList.add('hidden');
      refreshBtn.disabled = true;
      debugLogs = [];
      
      try {
        const apiBase = window.location.origin;
        addLog(`üåê URL de base: ${apiBase}`);
        addLog('---');
        
        const projects = [];
        
        for (const project of projectsConfig) {
          addLog(`üìä Traitement de ${project.name}...`);
          
          try {
            const feesUrl = `${apiBase}/api/fees?protocol=${project.defillamaSlug}`;
            addLog(`Appel: ${feesUrl}`);
            
            const feesResponse = await fetch(feesUrl);
            
            if (!feesResponse.ok) {
              addLog(`‚ùå Erreur ${feesResponse.status}`);
              continue;
            }
            
            const feesData = await feesResponse.json();
            
            addLog(`‚úÖ Donn√©es re√ßues`);
            if (feesData.logo) {
              addLog(`‚úÖ Logo trouv√©: ${feesData.logo}`);
            } else {
              addLog(`‚ö†Ô∏è Pas de logo dans les donn√©es`);
            }
            
            const fees24h = feesData.total24h || 0;
            const fees7d = feesData.total7d || 0;
            const avgDailyRevenue = fees7d / 7;
            const annualRevenue = avgDailyRevenue * 365;
            
            addLog(`‚úÖ Fees 24h: $${fees24h.toLocaleString()}`);
            addLog(`‚úÖ Fees 7d: $${fees7d.toLocaleString()}`);
            addLog(`‚úÖ Moyenne quotidienne (7j): $${avgDailyRevenue.toLocaleString()}`);
            
            let fdv = null;
            
            if (project.hasToken && project.coingeckoId) {
              const geckoUrl = `${apiBase}/api/coingecko?coinId=${project.coingeckoId}`;
              const geckoResponse = await fetch(geckoUrl);
              
              if (geckoResponse.ok) {
                const geckoData = await geckoResponse.json();
                fdv = geckoData.fdv;
                addLog(`‚úÖ FDV: $${fdv?.toLocaleString() || 'N/A'}`);
              }
            }
            
            projects.push({
              name: project.name,
              revenue: annualRevenue,
              fdv: fdv,
              estimated: false,
              hasToken: project.hasToken,
              daily24hFees: fees24h,
              avgDailyFees: avgDailyRevenue,
              logo: feesData.logo || null
            });
            
            addLog('---');
          } catch (err) {
            addLog(`‚ùå Erreur: ${err.message}`);
          }
        }
        
        const projectsWithFDV = projects.filter(p => p.fdv !== null && p.revenue > 0);
        
        if (projectsWithFDV.length > 0) {
          const ratios = projectsWithFDV.map(p => p.fdv / p.revenue);
          const avgRatio = ratios.reduce((a, b) => a + b, 0) / ratios.length;
          
          projects.forEach(project => {
            if (project.fdv === null && project.revenue > 0) {
              project.fdv = project.revenue * avgRatio;
              project.estimated = true;
            }
          });
        }
        
        projects.sort((a, b) => {
          if (a.hasToken !== b.hasToken) {
            return b.hasToken ? 1 : -1;
          }
          return (b.fdv || 0) - (a.fdv || 0);
        });
        
        allProjects = projects;
        
        createScatterChart(allProjects);
        renderTable(allProjects);
        
        document.getElementById('lastUpdate').textContent = 
          `Derni√®re mise √† jour: ${new Date().toLocaleString('fr-FR')}`;
        
        contentDiv.classList.remove('hidden');
        
      } catch (err) {
        errorDiv.textContent = `Erreur: ${err.message}`;
        errorDiv.classList.remove('hidden');
        addLog(`‚ùå Erreur fatale: ${err.message}`);
      } finally {
        loadingDiv.classList.add('hidden');
        refreshBtn.disabled = false;
      }
    }

    async function createScatterChart(projects) {
      const ctx = document.getElementById('scatterChart');
      
      if (scatterChartInstance) {
        scatterChartInstance.destroy();
      }
      
      const scatterData = projects
        .filter(p => p.fdv !== null && p.fdv !== undefined && p.revenue !== null && p.revenue !== undefined)
        .map(p => ({
          x: p.revenue,
          y: p.fdv,
          label: p.name,
          estimated: p.estimated,
          logo: p.logo
        }));
      
      addLog(`üìä ${scatterData.length} points √† afficher`);
      
      const n = scatterData.length;
      if (n < 2) {
        console.warn('Pas assez de donn√©es pour la r√©gression');
        return;
      }
      
      const sumX = scatterData.reduce((sum, point) => sum + point.x, 0);
      const sumY = scatterData.reduce((sum, point) => sum + point.y, 0);
      const sumXY = scatterData.reduce((sum, point) => sum + point.x * point.y, 0);
      const sumX2 = scatterData.reduce((sum, point) => sum + point.x * point.x, 0);
      
      const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
      const intercept = (sumY - slope * sumX) / n;
      
      const allX = scatterData.map(p => p.x);
      const allY = scatterData.map(p => p.y);
      const minX = Math.min(...allX);
      const maxX = Math.max(...allX);
      
      // Pour l'√©chelle log, on √©tend l√©g√®rement sans aller trop loin
      const extendedMinX = minX * 0.5;
      const extendedMaxX = maxX * 2;
      
      const regressionLine = [
        { x: extendedMinX, y: slope * extendedMinX + intercept },
        { x: extendedMaxX, y: slope * extendedMaxX + intercept }
      ];
      
      scatterChartInstance = new Chart(ctx, {
        type: 'scatter',
        data: {
          datasets: [
            {
              label: 'Projets avec token',
              data: scatterData.filter(p => !p.estimated),
              backgroundColor: '#4f46e5',
              borderColor: '#4f46e5',
              pointRadius: 12,
              pointHoverRadius: 14,
              pointHitRadius: 12,
              pointStyle: function(context) {
                const point = context.raw;
                if (point && point.logo && logoImages[point.label]) {
                  return logoImages[point.label];
                }
                return 'circle';
              }
            },
            {
              label: 'Projets estim√©s',
              data: scatterData.filter(p => p.estimated),
              backgroundColor: '#f59e0b',
              borderColor: '#f59e0b',
              pointRadius: 12,
              pointHoverRadius: 14,
              pointHitRadius: 12,
              pointStyle: function(context) {
                const point = context.raw;
                if (point && point.logo && logoImages[point.label]) {
                  return logoImages[point.label];
                }
                return 'circle';
              }
            },
            {
              label: 'Droite de r√©gression (moyenne)',
              data: regressionLine,
              type: 'line',
              borderColor: '#f97316',
              borderWidth: 3,
              borderDash: [5, 5],
              fill: false,
              pointRadius: 0,
              pointHoverRadius: 0,
              hitRadius: 0,
              hoverBorderWidth: 0,
              tension: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          interaction: {
            mode: 'point',
            intersect: true
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                usePointStyle: true,
                padding: 15,
                font: {
                  size: 12
                },
                filter: function(item, chart) {
                  return item.datasetIndex !== 2 || item.text !== '';
                }
              }
            },
            tooltip: {
              enabled: true,
              mode: 'point',
              intersect: true,
              filter: function(tooltipItem) {
                return tooltipItem.datasetIndex !== 2;
              },
              callbacks: {
                title: function(context) {
                  if (context.length === 0) return '';
                  return context[0].raw.label || '';
                },
                label: function(context) {
                  const x = context.parsed.x;
                  const y = context.parsed.y;
                  return [
                    `Revenu annuel: ${formatCurrency(x)}`,
                    `FDV: ${formatCurrency(y)}`,
                    `Ratio: ${x !== 0 ? (y/x).toFixed(1) + 'x' : 'N/A'}`
                  ];
                }
              }
            },
            datalabels: {
              display: function(context) {
                return context.dataset.type !== 'line';
              },
              align: 'top',
              offset: 8,
              font: {
                weight: 'bold',
                size: 11
              },
              formatter: function(value, context) {
                return value.label;
              },
              color: function(context) {
                return context.dataset.backgroundColor;
              }
            }
          },
          scales: {
            x: {
              type: 'logarithmic',
              position: 'bottom',
              title: {
                display: true,
                text: 'Revenu Annuel (USD) - √âchelle Log',
                font: {
                  size: 14,
                  weight: 'bold'
                }
              },
              ticks: {
                callback: function(value, index, ticks) {
                  // N'afficher que 1, 5, 10, 50, 100, 500, 1000, etc.
                  const log = Math.log10(value);
                  const base = Math.pow(10, Math.floor(log));
                  const mantissa = value / base;
                  
                  if (mantissa === 1 || mantissa === 5) {
                    return formatCurrency(value);
                  }
                  return '';
                }
              },
              grid: {
                display: true,
                drawBorder: true
              }
            },
            y: {
              type: 'logarithmic',
              title: {
                display: true,
                text: 'FDV (USD) - √âchelle Log',
                font: {
                  size: 14,
                  weight: 'bold'
                }
              },
              ticks: {
                callback: function(value, index, ticks) {
                  // N'afficher que 1, 5, 10, 50, 100, 500, 1000, etc.
                  const log = Math.log10(value);
                  const base = Math.pow(10, Math.floor(log));
                  const mantissa = value / base;
                  
                  if (mantissa === 1 || mantissa === 5) {
                    return formatCurrency(value);
                  }
                  return '';
                }
              },
              grid: {
                display: true,
                drawBorder: true
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
      
      addLog('‚úÖ Graphique cr√©√© avec succ√®s!');
    }

    function sortTable(column) {
      if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.column = column;
        currentSort.direction = 'desc';
      }
      
      const sorted = [...allProjects].sort((a, b) => {
        let valA, valB;
        
        switch(column) {
          case 'name':
            valA = a.name.toLowerCase();
            valB = b.name.toLowerCase();
            return currentSort.direction === 'asc' 
              ? valA.localeCompare(valB)
              : valB.localeCompare(valA);
          
          case 'daily24hFees':
            valA = a.daily24hFees || 0;
            valB = b.daily24hFees || 0;
            break;
          
          case 'avgDailyFees':
            valA = a.avgDailyFees || 0;
            valB = b.avgDailyFees || 0;
            break;
          
          case 'revenue':
            valA = a.revenue || 0;
            valB = b.revenue || 0;
            break;
          
          case 'fdv':
            valA = a.fdv || 0;
            valB = b.fdv || 0;
            break;
          
          case 'ratio':
            valA = (a.fdv && a.revenue) ? a.fdv / a.revenue : 0;
            valB = (b.fdv && b.revenue) ? b.fdv / b.revenue : 0;
            break;
          
          case 'hasToken':
            valA = a.hasToken ? 1 : 0;
            valB = b.hasToken ? 1 : 0;
            break;
          
          default:
            return 0;
        }
        
        return currentSort.direction === 'asc' ? valA - valB : valB - valA;
      });
      
      updateSortIndicators();
      renderTable(sorted);
    }

    function updateSortIndicators() {
      ['name', 'avgDailyFees', 'revenue', 'fdv', 'ratio', 'hasToken'].forEach(col => {
        const indicator = document.getElementById(`sort-${col}`);
        if (indicator) {
          indicator.textContent = '‚ÜïÔ∏è';
        }
      });
      
      const activeIndicator = document.getElementById(`sort-${currentSort.column}`);
      if (activeIndicator) {
        activeIndicator.textContent = currentSort.direction === 'asc' ? '‚Üë' : '‚Üì';
      }
    }

    function renderTable(projects) {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      
      projects.forEach((project, index) => {
        const row = document.createElement('tr');
        row.className = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';
        
        row.innerHTML = `
          <td class="px-3 py-2 font-medium">${project.name}</td>
          <td class="px-3 py-2 text-right font-semibold">${formatCurrency(project.avgDailyFees)}</td>
          <td class="px-3 py-2 text-right">${formatCurrency(project.revenue)}</td>
          <td class="px-3 py-2 text-right">${formatCurrency(project.fdv)}${project.estimated ? ' *' : ''}</td>
          <td class="px-3 py-2 text-right">${project.fdv && project.revenue ? (project.fdv / project.revenue).toFixed(1) + 'x' : 'N/A'}</td>
          <td class="px-3 py-2 text-center">
            <span class="px-2 py-1 rounded text-xs ${project.hasToken ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
              ${project.hasToken ? '‚úì Live' : '‚è≥ Estim√©'}
            </span>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    document.getElementById('refreshBtn').addEventListener('click', fetchData);
    
    fetchData();
  </script>
</body>
</html>
