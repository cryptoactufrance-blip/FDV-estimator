import React, { useState, useEffect } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, Scatter, ScatterChart, ResponsiveContainer } from 'recharts';

const CryptoFDVEstimator = () => {
  const [projects, setProjects] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [lastUpdate, setLastUpdate] = useState(null);

  // Configuration des projets
  const projectsConfig = [
    { name: 'Hyperliquid', hasToken: true, slug: 'hyperliquid' },
    { name: 'Extended', hasToken: false, slug: 'extended' }
  ];

  const fetchData = async () => {
    setLoading(true);
    setError(null);
    
    try {
      const results = [];
      
      for (const project of projectsConfig) {
        try {
          // R√©cup√©rer les revenus depuis DeFiLlama
          const feesResponse = await fetch(`https://api.llama.fi/summary/fees/${project.slug}?dataType=dailyFees`);
          
          if (!feesResponse.ok) {
            console.warn(`Donn√©es de revenus non disponibles pour ${project.name}`);
            continue;
          }
          
          const feesData = await feesResponse.json();
          
          // Calculer le revenu annuel (derniers 30 jours * 12)
          const last30Days = feesData.total24h || 0;
          const annualRevenue = last30Days * 365;
          
          let fdv = null;
          let estimated = false;
          
          if (project.hasToken) {
            // R√©cup√©rer la FDV depuis CoinGecko
            try {
              const geckoResponse = await fetch(
                `https://api.coingecko.com/api/v3/coins/${project.slug.toLowerCase()}`,
                {
                  headers: {
                    'x-cg-demo-api-key': 'CG-QgrMAHBWtELivvPG367nTZU4'
                  }
                }
              );
              
              if (geckoResponse.ok) {
                const geckoData = await geckoResponse.json();
                fdv = geckoData.market_data?.fully_diluted_valuation?.usd || null;
              }
            } catch (err) {
              console.warn(`Erreur CoinGecko pour ${project.name}:`, err);
            }
          }
          
          results.push({
            name: project.name,
            revenue: annualRevenue,
            fdv: fdv,
            estimated: estimated,
            hasToken: project.hasToken
          });
        } catch (err) {
          console.warn(`Erreur pour ${project.name}:`, err);
        }
      }
      
      // Calculer la r√©gression lin√©aire
      const projectsWithFDV = results.filter(p => p.fdv !== null && p.revenue > 0);
      
      if (projectsWithFDV.length > 0) {
        // Calcul simple du ratio moyen FDV/Revenue
        const ratios = projectsWithFDV.map(p => p.fdv / p.revenue);
        const avgRatio = ratios.reduce((a, b) => a + b, 0) / ratios.length;
        
        // Estimer la FDV pour les projets sans token
        results.forEach(project => {
          if (project.fdv === null && project.revenue > 0) {
            project.fdv = project.revenue * avgRatio;
            project.estimated = true;
          }
        });
      }
      
      // Trier par FDV d√©croissante
      results.sort((a, b) => (b.fdv || 0) - (a.fdv || 0));
      
      setProjects(results);
      setLastUpdate(new Date());
    } catch (err) {
      setError(`Erreur lors du chargement des donn√©es: ${err.message}`);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
    
    // Mise √† jour quotidienne (24h)
    const interval = setInterval(fetchData, 24 * 60 * 60 * 1000);
    return () => clearInterval(interval);
  }, []);

  const formatCurrency = (value) => {
    if (!value) return 'N/A';
    return new Intl.NumberFormat('fr-FR', {
      style: 'currency',
      currency: 'USD',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(value);
  };

  const formatNumber = (value) => {
    if (!value) return 'N/A';
    return new Intl.NumberFormat('fr-FR', {
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(value);
  };

  // Pr√©parer les donn√©es pour le graphique
  const chartData = projects.filter(p => p.revenue > 0 && p.fdv > 0);

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
      <div className="max-w-6xl mx-auto">
        <div className="bg-white rounded-lg shadow-xl p-8">
          <h1 className="text-3xl font-bold text-gray-800 mb-2">
            Estimateur FDV de Token Crypto
          </h1>
          <p className="text-gray-600 mb-6">
            Estimation de la Fully Diluted Valuation bas√©e sur les revenus des projets
          </p>

          {lastUpdate && (
            <p className="text-sm text-gray-500 mb-4">
              Derni√®re mise √† jour: {lastUpdate.toLocaleString('fr-FR')}
            </p>
          )}

          <button
            onClick={fetchData}
            disabled={loading}
            className="mb-6 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 disabled:bg-gray-400 transition"
          >
            {loading ? 'Chargement...' : 'Actualiser les donn√©es'}
          </button>

          {error && (
            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
              {error}
            </div>
          )}

          {loading ? (
            <div className="text-center py-12">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
              <p className="mt-4 text-gray-600">Chargement des donn√©es...</p>
            </div>
          ) : (
            <>
              {/* Tableau */}
              <div className="mb-8 overflow-x-auto">
                <table className="w-full border-collapse">
                  <thead>
                    <tr className="bg-indigo-600 text-white">
                      <th className="px-4 py-3 text-left">Projet</th>
                      <th className="px-4 py-3 text-right">Revenu Annuel</th>
                      <th className="px-4 py-3 text-right">FDV</th>
                      <th className="px-4 py-3 text-right">Ratio FDV/Revenu</th>
                      <th className="px-4 py-3 text-center">Statut</th>
                    </tr>
                  </thead>
                  <tbody>
                    {projects.map((project, index) => (
                      <tr 
                        key={project.name}
                        className={index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}
                      >
                        <td className="px-4 py-3 font-medium">{project.name}</td>
                        <td className="px-4 py-3 text-right">{formatCurrency(project.revenue)}</td>
                        <td className="px-4 py-3 text-right">
                          {formatCurrency(project.fdv)}
                          {project.estimated && (
                            <span className="ml-2 text-xs text-orange-600">*estim√©</span>
                          )}
                        </td>
                        <td className="px-4 py-3 text-right">
                          {project.fdv && project.revenue 
                            ? `${(project.fdv / project.revenue).toFixed(1)}x`
                            : 'N/A'}
                        </td>
                        <td className="px-4 py-3 text-center">
                          <span className={`px-2 py-1 rounded text-xs ${
                            project.hasToken 
                              ? 'bg-green-100 text-green-800' 
                              : 'bg-yellow-100 text-yellow-800'
                          }`}>
                            {project.hasToken ? 'Live' : 'Pas encore live'}
                          </span>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              {/* Graphique */}
              {chartData.length > 0 && (
                <div className="mt-8">
                  <h2 className="text-xl font-bold text-gray-800 mb-4">
                    Corr√©lation Revenu / FDV
                  </h2>
                  <ResponsiveContainer width="100%" height={400}>
                    <ScatterChart margin={{ top: 20, right: 20, bottom: 60, left: 80 }}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis 
                        dataKey="revenue" 
                        type="number" 
                        name="Revenu Annuel"
                        label={{ value: 'Revenu Annuel (USD)', position: 'insideBottom', offset: -10 }}
                        tickFormatter={(value) => `$${(value / 1e6).toFixed(0)}M`}
                      />
                      <YAxis 
                        dataKey="fdv" 
                        type="number" 
                        name="FDV"
                        label={{ value: 'FDV (USD)', angle: -90, position: 'insideLeft' }}
                        tickFormatter={(value) => `$${(value / 1e9).toFixed(1)}B`}
                      />
                      <Tooltip 
                        formatter={(value, name) => {
                          if (name === 'FDV') return formatCurrency(value);
                          if (name === 'Revenu Annuel') return formatCurrency(value);
                          return value;
                        }}
                        labelFormatter={(label, payload) => {
                          if (payload && payload[0]) {
                            return payload[0].payload.name;
                          }
                          return label;
                        }}
                      />
                      <Legend />
                      <Scatter 
                        name="Projets" 
                        data={chartData} 
                        fill="#4f46e5"
                        shape={(props) => {
                          const { cx, cy, payload } = props;
                          return (
                            <g>
                              <circle 
                                cx={cx} 
                                cy={cy} 
                                r={8} 
                                fill={payload.estimated ? '#f59e0b' : '#4f46e5'}
                                stroke="#fff"
                                strokeWidth={2}
                              />
                            </g>
                          );
                        }}
                      />
                    </ScatterChart>
                  </ResponsiveContainer>
                  <p className="text-sm text-gray-600 mt-2 text-center">
                    <span className="inline-block w-3 h-3 bg-indigo-600 rounded-full mr-1"></span> Projets live
                    <span className="inline-block w-3 h-3 bg-orange-500 rounded-full ml-4 mr-1"></span> Projets estim√©s
                  </p>
                </div>
              )}

              <div className="mt-8 p-4 bg-blue-50 rounded-lg">
                <h3 className="font-semibold text-gray-800 mb-2">üí° Comment √ßa marche ?</h3>
                <ul className="text-sm text-gray-700 space-y-1">
                  <li>‚Ä¢ Les donn√©es de revenus proviennent de DeFiLlama</li>
                  <li>‚Ä¢ Les FDV des tokens live proviennent de CoinGecko</li>
                  <li>‚Ä¢ La FDV des projets sans token est estim√©e via r√©gression lin√©aire</li>
                  <li>‚Ä¢ Les donn√©es sont mises √† jour automatiquement une fois par jour</li>
                </ul>
              </div>
            </>
          )}
        </div>
      </div>
    </div>
  );
};

export default CryptoFDVEstimator;
