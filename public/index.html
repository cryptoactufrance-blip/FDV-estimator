<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Estimateur FDV Crypto</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .bar {
      transition: width 0.5s ease;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div class="max-w-6xl mx-auto p-8">
    <div class="bg-white rounded-lg shadow-xl p-8">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">üöÄ Estimateur FDV de Token Crypto</h1>
      <p class="text-gray-600 mb-6">Estimation automatique via Vercel Edge Functions</p>
      
      <p id="lastUpdate" class="text-sm text-gray-500 mb-4"></p>
      
      <button 
        id="refreshBtn" 
        class="mb-6 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition"
      >
        üîÑ Actualiser les donn√©es
      </button>
      
      <div id="error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6"></div>
      
      <div id="loading" class="hidden text-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
        <p class="mt-4 text-gray-600">R√©cup√©ration des donn√©es...</p>
      </div>
      
      <div id="content" class="hidden">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Comparaison Revenu vs FDV</h2>
        <div id="charts" class="space-y-6 mb-8"></div>
        
        <h2 class="text-xl font-bold text-gray-800 mb-4">Donn√©es d√©taill√©es</h2>
        <div class="overflow-x-auto mb-8">
          <table class="w-full border-collapse text-sm">
            <thead>
              <tr class="bg-indigo-600 text-white">
                <th class="px-3 py-2 text-left cursor-pointer hover:bg-indigo-700" onclick="sortTable('name')">
                  Projet <span id="sort-name" class="text-xs">‚ÜïÔ∏è</span>
                </th>
                <th class="px-3 py-2 text-right cursor-pointer hover:bg-indigo-700" onclick="sortTable('daily24hFees')">
                  Fees 24h <span id="sort-daily24hFees" class="text-xs">‚ÜïÔ∏è</span>
                </th>
                <th class="px-3 py-2 text-right cursor-pointer hover:bg-indigo-700" onclick="sortTable('avgDailyFees')">
                  Moy. 7j <span id="sort-avgDailyFees" class="text-xs">‚ÜïÔ∏è</span>
                </th>
                <th class="px-3 py-2 text-right cursor-pointer hover:bg-indigo-700" onclick="sortTable('revenue')">
                  Revenu Annuel <span id="sort-revenue" class="text-xs">‚ÜïÔ∏è</span>
                </th>
                <th class="px-3 py-2 text-right cursor-pointer hover:bg-indigo-700" onclick="sortTable('fdv')">
                  FDV <span id="sort-fdv" class="text-xs">‚ÜïÔ∏è</span>
                </th>
                <th class="px-3 py-2 text-right cursor-pointer hover:bg-indigo-700" onclick="sortTable('ratio')">
                  Ratio <span id="sort-ratio" class="text-xs">‚ÜïÔ∏è</span>
                </th>
                <th class="px-3 py-2 text-center cursor-pointer hover:bg-indigo-700" onclick="sortTable('hasToken')">
                  Statut <span id="sort-hasToken" class="text-xs">‚Üì</span>
                </th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
        
        <div class="p-4 bg-blue-50 rounded-lg">
          <h3 class="font-semibold text-gray-800 mb-2">üí° Comment √ßa marche ?</h3>
          <ul class="text-sm text-gray-700 space-y-1">
            <li>‚Ä¢ Vercel Edge Functions : API backend qui contourne CORS</li>
            <li>‚Ä¢ DeFiLlama : Donn√©es de revenus en temps r√©el</li>
            <li>‚Ä¢ CoinGecko : FDV des tokens live</li>
            <li>‚Ä¢ R√©gression lin√©aire : Estimation automatique des FDV</li>
          </ul>
        </div>
      </div>
      
      <details class="mt-6">
        <summary class="cursor-pointer text-sm font-semibold text-gray-700 hover:text-gray-900">
          üîç Logs de debug
        </summary>
        <div id="debugLogs" class="mt-2 p-4 bg-gray-100 rounded text-xs font-mono overflow-x-auto max-h-96 overflow-y-auto"></div>
      </details>
    </div>
  </div>

  <script>
    let allProjects = [];
    let currentSort = { column: 'hasToken', direction: 'desc' };
    
    const projectsConfig = [
      { 
        name: 'Hyperliquid', 
        hasToken: true, 
        defillamaSlug: 'hyperliquid',
        coingeckoId: 'hyperliquid'
      },
      { 
        name: 'Lighter', 
        hasToken: true, 
        defillamaSlug: 'lighter',
        coingeckoId: 'lighter'
      },
      { 
        name: 'Aster', 
        hasToken: true, 
        defillamaSlug: 'aster',
        coingeckoId: 'aster-2'
      },
      { 
        name: 'dYdX', 
        hasToken: true, 
        defillamaSlug: 'dydx',
        coingeckoId: 'dydx-chain'
      },
      { 
        name: 'Avantis', 
        hasToken: true, 
        defillamaSlug: 'avantis',
        coingeckoId: 'avantis'
      },
      { 
        name: 'Extended', 
        hasToken: false, 
        defillamaSlug: 'extended',
        coingeckoId: null
      }
    ];

    let debugLogs = [];

    function addLog(message) {
      debugLogs.push(message);
      const logsDiv = document.getElementById('debugLogs');
      logsDiv.innerHTML = debugLogs.join('<br>');
    }

    function formatCurrency(value) {
      if (!value) return 'N/A';
      if (value >= 1e9) return `$${(value / 1e9).toFixed(2)}B`;
      if (value >= 1e6) return `$${(value / 1e6).toFixed(2)}M`;
      if (value >= 1e3) return `$${(value / 1e3).toFixed(2)}K`;
      return `$${value.toFixed(2)}`;
    }

    async function fetchData() {
      const loadingDiv = document.getElementById('loading');
      const contentDiv = document.getElementById('content');
      const errorDiv = document.getElementById('error');
      const refreshBtn = document.getElementById('refreshBtn');
      
      loadingDiv.classList.remove('hidden');
      contentDiv.classList.add('hidden');
      errorDiv.classList.add('hidden');
      refreshBtn.disabled = true;
      debugLogs = [];
      
      try {
        const apiBase = window.location.origin;
        addLog(`üåê URL de base: ${apiBase}`);
        addLog('---');
        
        const projects = [];
        
        for (const project of projectsConfig) {
          addLog(`üìä Traitement de ${project.name}...`);
          
          try {
            const feesUrl = `${apiBase}/api/fees?protocol=${project.defillamaSlug}`;
            addLog(`Appel: ${feesUrl}`);
            
            const feesResponse = await fetch(feesUrl);
            
            if (!feesResponse.ok) {
              addLog(`‚ùå Erreur ${feesResponse.status}`);
              continue;
            }
            
            const feesData = await feesResponse.json();
            
            // Calculer la moyenne sur 7 jours
            const fees24h = feesData.total24h || 0;
            const fees7d = feesData.total7d || 0;
            const avgDailyRevenue = fees7d / 7;
            const annualRevenue = avgDailyRevenue * 365;
            
            addLog(`‚úÖ Fees 24h: ${fees24h.toLocaleString()}`);
            addLog(`‚úÖ Fees 7d: ${fees7d.toLocaleString()}`);
            addLog(`‚úÖ Moyenne quotidienne (7j): ${avgDailyRevenue.toLocaleString()}`);
            
            const dailyRevenue = avgDailyRevenue;
            
            let fdv = null;
            
            if (project.hasToken && project.coingeckoId) {
              const geckoUrl = `${apiBase}/api/coingecko?coinId=${project.coingeckoId}`;
              const geckoResponse = await fetch(geckoUrl);
              
              if (geckoResponse.ok) {
                const geckoData = await geckoResponse.json();
                fdv = geckoData.fdv;
                addLog(`‚úÖ FDV: $${fdv?.toLocaleString() || 'N/A'}`);
              }
            }
            
            projects.push({
              name: project.name,
              revenue: annualRevenue,
              fdv: fdv,
              estimated: false,
              hasToken: project.hasToken,
              daily24hFees: fees24h,
              avgDailyFees: avgDailyRevenue
            });
            
            addLog('---');
          } catch (err) {
            addLog(`‚ùå Erreur: ${err.message}`);
          }
        }
        
        // R√©gression lin√©aire
        const projectsWithFDV = projects.filter(p => p.fdv !== null && p.revenue > 0);
        
        if (projectsWithFDV.length > 0) {
          const ratios = projectsWithFDV.map(p => p.fdv / p.revenue);
          const avgRatio = ratios.reduce((a, b) => a + b, 0) / ratios.length;
          
          projects.forEach(project => {
            if (project.fdv === null && project.revenue > 0) {
              project.fdv = project.revenue * avgRatio;
              project.estimated = true;
            }
          });
        }
        
        projects.sort((a, b) => {
          // Trier d'abord par statut (token live en premier)
          if (a.hasToken !== b.hasToken) {
            return b.hasToken ? 1 : -1;
          }
          // Ensuite par FDV d√©croissante
          return (b.fdv || 0) - (a.fdv || 0);
        });
        
        allProjects = projects;
        
        // Afficher les graphiques
        renderCharts(allProjects);
        
        // Afficher le tableau
        renderTable(allProjects);
        
        // Mettre √† jour la date
        document.getElementById('lastUpdate').textContent = 
          `Derni√®re mise √† jour: ${new Date().toLocaleString('fr-FR')}`;
        
        contentDiv.classList.remove('hidden');
        
      } catch (err) {
        errorDiv.textContent = `Erreur: ${err.message}`;
        errorDiv.classList.remove('hidden');
        addLog(`‚ùå Erreur fatale: ${err.message}`);
      } finally {
        loadingDiv.classList.add('hidden');
        refreshBtn.disabled = false;
      }
    }

    function renderCharts(projects) {
      const chartsDiv = document.getElementById('charts');
      chartsDiv.innerHTML = '';
      
      const maxValue = Math.max(...projects.map(p => Math.max(p.revenue || 0, p.fdv || 0)));
      
      projects.forEach(project => {
        const projectDiv = document.createElement('div');
        projectDiv.className = 'border-b pb-4';
        
        projectDiv.innerHTML = `
          <div class="font-semibold text-gray-800 mb-2 flex justify-between items-center">
            <span>${project.name}</span>
            <span class="text-xs px-2 py-1 rounded ${project.hasToken ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
              ${project.hasToken ? '‚úì Live' : '‚è≥ Estim√©'}
            </span>
          </div>
          <div class="space-y-2">
            <div class="text-xs text-gray-500 mb-2">
              Fees 24h: ${formatCurrency(project.daily24hFees)} | Moyenne 7j: ${formatCurrency(project.avgDailyFees)}
            </div>
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-600">Revenu Annuel</span>
                <span class="font-semibold text-green-600">${formatCurrency(project.revenue)}</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-4">
                <div class="bar bg-green-500 h-4 rounded-full" style="width: ${(project.revenue / maxValue * 100)}%"></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-600">FDV${project.estimated ? ' (estim√©e)' : ''}</span>
                <span class="font-semibold ${project.estimated ? 'text-orange-600' : 'text-indigo-600'}">${formatCurrency(project.fdv)}</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-4">
                <div class="bar ${project.estimated ? 'bg-orange-500' : 'bg-indigo-600'} h-4 rounded-full" style="width: ${(project.fdv / maxValue * 100)}%"></div>
              </div>
            </div>
            <div class="text-sm text-gray-600 mt-1">
              Ratio FDV/Revenu: ${project.fdv && project.revenue ? (project.fdv / project.revenue).toFixed(1) + 'x' : 'N/A'}
            </div>
          </div>
        `;
        
        chartsDiv.appendChild(projectDiv);
      });
    }

    function sortTable(column) {
      // Inverser la direction si on clique sur la m√™me colonne
      if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.column = column;
        currentSort.direction = 'desc';
      }
      
      // Trier les projets
      const sorted = [...allProjects].sort((a, b) => {
        let valA, valB;
        
        switch(column) {
          case 'name':
            valA = a.name.toLowerCase();
            valB = b.name.toLowerCase();
            return currentSort.direction === 'asc' 
              ? valA.localeCompare(valB)
              : valB.localeCompare(valA);
          
          case 'daily24hFees':
            valA = a.daily24hFees || 0;
            valB = b.daily24hFees || 0;
            break;
          
          case 'avgDailyFees':
            valA = a.avgDailyFees || 0;
            valB = b.avgDailyFees || 0;
            break;
          
          case 'revenue':
            valA = a.revenue || 0;
            valB = b.revenue || 0;
            break;
          
          case 'fdv':
            valA = a.fdv || 0;
            valB = b.fdv || 0;
            break;
          
          case 'ratio':
            valA = (a.fdv && a.revenue) ? a.fdv / a.revenue : 0;
            valB = (b.fdv && b.revenue) ? b.fdv / b.revenue : 0;
            break;
          
          case 'hasToken':
            valA = a.hasToken ? 1 : 0;
            valB = b.hasToken ? 1 : 0;
            break;
          
          default:
            return 0;
        }
        
        return currentSort.direction === 'asc' ? valA - valB : valB - valA;
      });
      
      // Mettre √† jour les indicateurs de tri
      updateSortIndicators();
      
      // R√©afficher le tableau
      renderTable(sorted);
    }
    
    function updateSortIndicators() {
      // R√©initialiser tous les indicateurs
      ['name', 'daily24hFees', 'avgDailyFees', 'revenue', 'fdv', 'ratio', 'hasToken'].forEach(col => {
        const indicator = document.getElementById(`sort-${col}`);
        if (indicator) {
          indicator.textContent = '‚ÜïÔ∏è';
        }
      });
      
      // Mettre √† jour l'indicateur de la colonne active
      const activeIndicator = document.getElementById(`sort-${currentSort.column}`);
      if (activeIndicator) {
        activeIndicator.textContent = currentSort.direction === 'asc' ? '‚Üë' : '‚Üì';
      }
    }

    function renderTable(projects) {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      
      projects.forEach((project, index) => {
        const row = document.createElement('tr');
        row.className = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';
        
        row.innerHTML = `
          <td class="px-3 py-2 font-medium">${project.name}</td>
          <td class="px-3 py-2 text-right">${formatCurrency(project.daily24hFees)}</td>
          <td class="px-3 py-2 text-right font-semibold">${formatCurrency(project.avgDailyFees)}</td>
          <td class="px-3 py-2 text-right">${formatCurrency(project.revenue)}</td>
          <td class="px-3 py-2 text-right">${formatCurrency(project.fdv)}${project.estimated ? ' *' : ''}</td>
          <td class="px-3 py-2 text-right">${project.fdv && project.revenue ? (project.fdv / project.revenue).toFixed(1) + 'x' : 'N/A'}</td>
          <td class="px-3 py-2 text-center">
            <span class="px-2 py-1 rounded text-xs ${project.hasToken ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
              ${project.hasToken ? '‚úì Live' : '‚è≥ Estim√©'}
            </span>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // Event listener
    document.getElementById('refreshBtn').addEventListener('click', fetchData);
    
    // Charger au d√©marrage
    fetchData();
  </script>
</body>
</html>
